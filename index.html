<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>D√©tecteur ALMA - Reconnaissance Vocale Locale</title>
  </head>
  <body>
    <div class="container">
      <h1>üéôÔ∏è D√©tecteur ALMA</h1>

      <div class="status-panel">
        <div id="status">Chargement...</div>

        <div class="led-container">
          <div id="alma-led" class="led"></div>
          <span class="led-label">ALMA d√©tect√©</span>
        </div>
      </div>

      <div class="controls">
        <button id="toggle-button" disabled>D√©marrer l'√©coute</button>
        <div id="listening-indicator" class="listening-indicator">
          <div class="pulse"></div>
          <span>√âcoute active...</span>
        </div>
      </div>

      <div class="audio-analysis">
        <div class="audio-level">
          <label>Niveau audio:</label>
          <div class="level-bar">
            <div id="audio-level-fill" class="level-fill"></div>
          </div>
          <span id="audio-level-text">0%</span>
        </div>

        <div class="silence-info">
          <span id="silence-status">En attente...</span>
          <span id="silence-duration"></span>
        </div>
      </div>

      <div id="output-container">
        <div id="output"></div>
      </div>
    </div>

    <script
      type="application/javascript"
      src="https://cdn.jsdelivr.net/npm/vosk-browser@0.0.5/dist/vosk.js"
    ></script>
    <script>
      const toggleButton = document.getElementById("toggle-button");
      const statusDiv = document.getElementById("status");
      const output = document.getElementById("output");
      const almaLed = document.getElementById("alma-led");
      const listeningIndicator = document.getElementById("listening-indicator");
      const audioLevelFill = document.getElementById("audio-level-fill");
      const audioLevelText = document.getElementById("audio-level-text");
      const silenceStatus = document.getElementById("silence-status");
      const silenceDuration = document.getElementById("silence-duration");

      let model = null;
      let recognizer = null;
      let audioContext = null;
      let recognizerNode = null;
      let analyserNode = null;
      let mediaStream = null;
      let source = null;
      let isListening = false;
      let almaTimer = null;

      // Variables pour g√©rer l'affichage
      let finalTranscript = "";
      let interimTranscript = "";

      // Variables pour la d√©tection de silence
      let silenceThreshold = 0.01; // Seuil de silence (ajustable)
      let silenceStartTime = null;
      let isSilent = false;
      let lastSpeechTime = Date.now();
      let audioData = new Uint8Array(1024);

      async function loadModel() {
        try {
          statusDiv.textContent = "Chargement du mod√®le Vosk...";
          console.log("D√©but du chargement du mod√®le");

          const modelUrl =
            window.location.origin +
            window.location.pathname.replace("index.html", "") +
            "model.tar.gz";
          console.log("URL du mod√®le:", modelUrl);

          model = await Vosk.createModel(modelUrl);
          console.log("Mod√®le charg√© avec succ√®s:", model);

          recognizer = new model.KaldiRecognizer(16000);
          console.log("Recognizer cr√©√©:", recognizer);

          // √âv√©nements de reconnaissance
          recognizer.on("result", (message) => {
            console.log("R√©sultat final:", message);
            if (message.result && message.result.text) {
              const finalText = message.result.text.trim();
              if (finalText) {
                // Ajouter timestamp et texte final
                const timestamp = new Date().toLocaleTimeString();
                addTranscriptEntry(timestamp, finalText, "final");

                // D√©tecter "alma" (insensible √† la casse)
                checkForAlma(finalText, "final");

                // Marquer qu'on a re√ßu de la parole
                lastSpeechTime = Date.now();

                // Garder seulement les derni√®res entr√©es
                limitOutput();
              }
            }
          });

          recognizer.on("partialresult", (message) => {
            console.log("R√©sultat partiel:", message);
            if (message.result && message.result.partial) {
              interimTranscript = message.result.partial.trim();
              updatePartialDisplay();
              lastSpeechTime = Date.now();

              // D√©tecter "alma" aussi dans les r√©sultats partiels
              checkForAlma(interimTranscript, "partiel");
            }
          });

          statusDiv.textContent =
            "Mod√®le charg√© - Pr√™t pour l'√©coute permanente";
          toggleButton.disabled = false;
          toggleButton.textContent = "D√©marrer l'√©coute";

          // D√©marrer automatiquement l'√©coute
          setTimeout(() => {
            startListening();
          }, 1000);
        } catch (error) {
          console.error("Erreur lors du chargement du mod√®le:", error);
          statusDiv.textContent = `Erreur de chargement: ${error.message}`;
        }
      }

      function addTranscriptEntry(timestamp, text, type) {
        const entry = document.createElement("div");
        entry.className = `transcript-entry ${type}`;

        const timeSpan = document.createElement("span");
        timeSpan.className = "timestamp";
        timeSpan.textContent = `[${timestamp}]`;

        const textSpan = document.createElement("span");
        textSpan.className = "transcript-text";
        textSpan.textContent = text;

        entry.appendChild(timeSpan);
        entry.appendChild(textSpan);

        output.appendChild(entry);

        // Auto-scroll vers le bas
        output.scrollTop = output.scrollHeight;
      }

      function updatePartialDisplay() {
        // Supprimer l'ancien texte partiel s'il existe
        const existingPartial = output.querySelector(
          ".transcript-entry.partial"
        );
        if (existingPartial) {
          existingPartial.remove();
        }

        // Ajouter le nouveau texte partiel
        if (interimTranscript) {
          const timestamp = new Date().toLocaleTimeString();
          addTranscriptEntry(
            timestamp,
            `[...] ${interimTranscript}`,
            "partial"
          );
        }
      }

      function checkForAlma(text, source = "") {
        if (text.toLowerCase().includes("alma")) {
          activateAlmaLed(source);
          return true;
        }
        return false;
      }

      function activateAlmaLed(source = "") {
        console.log(`üî¥ ALMA d√©tect√© ! (${source})`);
        almaLed.classList.add("active");

        // Ajouter une entr√©e sp√©ciale pour ALMA
        const timestamp = new Date().toLocaleTimeString();
        const sourceText = source ? ` (${source})` : "";
        addTranscriptEntry(
          timestamp,
          `üî¥ ALMA D√âTECT√â${sourceText}`,
          "alma-detection"
        );

        // Effacer le timer pr√©c√©dent s'il existe
        if (almaTimer) {
          clearTimeout(almaTimer);
        }

        // √âteindre le voyant apr√®s 10 secondes
        almaTimer = setTimeout(() => {
          almaLed.classList.remove("active");
          console.log("üî¥ Voyant ALMA √©teint");
        }, 10000);
      }

      function limitOutput() {
        // Garder seulement les 50 derni√®res entr√©es
        const entries = output.querySelectorAll(
          ".transcript-entry.final, .transcript-entry.alma-detection"
        );
        if (entries.length > 50) {
          for (let i = 0; i < entries.length - 50; i++) {
            entries[i].remove();
          }
        }
      }

      function analyzeAudioLevel() {
        if (!analyserNode || !isListening) return;

        analyserNode.getByteFrequencyData(audioData);

        // Calculer le niveau audio moyen
        let sum = 0;
        for (let i = 0; i < audioData.length; i++) {
          sum += audioData[i];
        }
        const average = sum / audioData.length;
        const level = average / 255; // Normaliser entre 0 et 1

        // Mettre √† jour l'affichage du niveau audio
        audioLevelFill.style.width = `${level * 100}%`;
        audioLevelText.textContent = `${Math.round(level * 100)}%`;

        // D√©tection de silence
        const currentTime = Date.now();

        if (level < silenceThreshold) {
          if (!isSilent) {
            // D√©but du silence
            silenceStartTime = currentTime;
            isSilent = true;
          } else {
            // Silence en cours
            const silenceDur = (currentTime - silenceStartTime) / 1000;
            if (silenceDur > 1.0) {
              silenceStatus.textContent = "üîá Silence d√©tect√©";
              silenceDuration.textContent = `${silenceDur.toFixed(1)}s`;

              // Ajouter une entr√©e de silence si √ßa dure plus de 2 secondes
              if (silenceDur > 2 && currentTime - lastSpeechTime > 2000) {
                const timestamp = new Date().toLocaleTimeString();
                addTranscriptEntry(
                  timestamp,
                  `üîá Silence (${silenceDur.toFixed(1)}s)`,
                  "silence"
                );
                lastSpeechTime = currentTime; // √âviter les doublons
              }
            }
          }
        } else {
          if (isSilent) {
            // Fin du silence
            const silenceDur = (currentTime - silenceStartTime) / 1000;
            if (silenceDur > 1.0) {
              console.log(`Silence termin√©: ${silenceDur.toFixed(1)}s`);
            }
            isSilent = false;
            silenceStartTime = null;
          }
          silenceStatus.textContent = "üé§ Parole d√©tect√©e";
          silenceDuration.textContent = "";
        }

        // Continuer l'analyse
        requestAnimationFrame(analyzeAudioLevel);
      }

      async function startListening() {
        if (isListening) return;

        try {
          console.log("D√©marrage de l'√©coute permanente");
          statusDiv.textContent = "Demande d'acc√®s au microphone...";

          mediaStream = await navigator.mediaDevices.getUserMedia({
            video: false,
            audio: {
              echoCancellation: true,
              noiseSuppression: false, // D√©sactiv√© pour l'analyse audio
              channelCount: 1,
              sampleRate: 16000,
            },
          });

          console.log("Microphone accessible, cr√©ation du contexte audio");

          audioContext = new (window.AudioContext || window.webkitAudioContext)(
            {
              sampleRate: 16000,
            }
          );

          // Cr√©er l'analyseur audio pour la d√©tection de silence
          analyserNode = audioContext.createAnalyser();
          analyserNode.fftSize = 2048;
          analyserNode.smoothingTimeConstant = 0.8;

          recognizerNode = audioContext.createScriptProcessor(4096, 1, 1);

          recognizerNode.onaudioprocess = (event) => {
            try {
              if (recognizer && event.inputBuffer) {
                recognizer.acceptWaveform(event.inputBuffer);
              }
            } catch (error) {
              console.error("Erreur dans le traitement audio:", error);
            }
          };

          source = audioContext.createMediaStreamSource(mediaStream);
          source.connect(analyserNode);
          source.connect(recognizerNode);
          recognizerNode.connect(audioContext.destination);

          isListening = true;
          statusDiv.textContent =
            "üéôÔ∏è √âcoute permanente active - Dites 'ALMA' pour activer le voyant";
          toggleButton.textContent = "Arr√™ter l'√©coute";
          listeningIndicator.style.display = "flex";

          // D√©marrer l'analyse audio
          analyzeAudioLevel();

          console.log("√âcoute permanente d√©marr√©e");
        } catch (error) {
          console.error("Erreur lors du d√©marrage:", error);
          statusDiv.textContent = `Erreur: ${error.message}`;
        }
      }

      function stopListening() {
        if (!isListening) return;

        try {
          console.log("Arr√™t de l'√©coute");

          if (recognizerNode) {
            recognizerNode.disconnect();
            recognizerNode = null;
          }

          if (analyserNode) {
            analyserNode.disconnect();
            analyserNode = null;
          }

          if (source) {
            source.disconnect();
            source = null;
          }

          if (audioContext && audioContext.state !== "closed") {
            audioContext.close();
            audioContext = null;
          }

          if (mediaStream) {
            mediaStream.getTracks().forEach((track) => track.stop());
            mediaStream = null;
          }

          isListening = false;
          statusDiv.textContent = "√âcoute arr√™t√©e - Cliquez pour red√©marrer";
          toggleButton.textContent = "D√©marrer l'√©coute";
          listeningIndicator.style.display = "none";

          // Reset de l'affichage audio
          audioLevelFill.style.width = "0%";
          audioLevelText.textContent = "0%";
          silenceStatus.textContent = "En attente...";
          silenceDuration.textContent = "";
        } catch (error) {
          console.error("Erreur lors de l'arr√™t:", error);
        }
      }

      function toggleListening() {
        if (isListening) {
          stopListening();
        } else {
          startListening();
        }
      }

      // √âv√©nements
      toggleButton.addEventListener("click", toggleListening);

      // V√©rifier si Vosk est disponible
      if (typeof Vosk === "undefined") {
        statusDiv.textContent = "Erreur: Vosk n'est pas charg√©";
        console.error("Vosk n'est pas disponible");
      } else {
        console.log("Vosk disponible, version:", Vosk.version || "inconnue");
        loadModel();
      }
    </script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 30px;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5em;
        font-weight: 300;
      }

      .status-panel {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 15px;
      }

      #status {
        font-weight: bold;
        color: #495057;
        font-size: 1.1em;
      }

      .led-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .led {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #6c757d;
        border: 3px solid #343a40;
        position: relative;
        transition: all 0.3s ease;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .led.active {
        background: #ff4757;
        border-color: #ff3742;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 20px #ff4757,
          0 0 40px #ff4757;
        animation: pulse-led 1s ease-in-out infinite alternate;
      }

      @keyframes pulse-led {
        from {
          box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 20px #ff4757,
            0 0 40px #ff4757;
        }
        to {
          box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 30px #ff4757,
            0 0 60px #ff4757;
        }
      }

      .led-label {
        font-weight: bold;
        color: #495057;
        font-size: 1.1em;
      }

      .controls {
        text-align: center;
        margin-bottom: 20px;
      }

      button {
        padding: 15px 30px;
        font-size: 18px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: bold;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
        transform: none;
        box-shadow: none;
      }

      .listening-indicator {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
        color: #28a745;
        font-weight: bold;
        font-size: 1.1em;
      }

      .pulse {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #28a745;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.3);
          opacity: 0.5;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .audio-analysis {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        align-items: center;
      }

      .audio-level {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .level-bar {
        flex: 1;
        height: 10px;
        background: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
      }

      .level-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          #28a745 0%,
          #ffc107 70%,
          #dc3545 100%
        );
        width: 0%;
        transition: width 0.1s ease;
      }

      .silence-info {
        text-align: right;
        font-weight: bold;
      }

      #silence-duration {
        color: #dc3545;
        margin-left: 10px;
      }

      #output-container {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        height: 400px;
        overflow: hidden;
      }

      #output {
        height: 100%;
        overflow-y: auto;
        padding: 15px;
      }

      .transcript-entry {
        margin-bottom: 8px;
        padding: 8px 12px;
        border-radius: 8px;
        display: flex;
        gap: 10px;
        align-items: flex-start;
      }

      .transcript-entry.final {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
      }

      .transcript-entry.partial {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
        font-style: italic;
      }

      .transcript-entry.alma-detection {
        background: #ffebee;
        border-left: 4px solid #f44336;
        font-weight: bold;
      }

      .transcript-entry.silence {
        background: #f3e5f5;
        border-left: 4px solid #9c27b0;
        font-style: italic;
        opacity: 0.8;
      }

      .timestamp {
        font-family: "Courier New", monospace;
        font-size: 0.9em;
        color: #666;
        white-space: nowrap;
        min-width: 90px;
      }

      .transcript-text {
        flex: 1;
        line-height: 1.4;
      }

      #output:empty::before {
        content: "üéôÔ∏è En attente de votre voix... Les timestamps et silences seront affich√©s ici";
        color: #6c757d;
        font-style: italic;
        display: block;
        text-align: center;
        margin-top: 50px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .status-panel,
        .audio-analysis {
          flex-direction: column;
          gap: 15px;
        }

        .audio-analysis {
          grid-template-columns: 1fr;
        }

        h1 {
          font-size: 2em;
        }

        .container {
          padding: 20px;
        }

        .timestamp {
          min-width: 70px;
          font-size: 0.8em;
        }
      }
    </style>
  </body>
</html>
